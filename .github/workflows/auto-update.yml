name: Auto Update Peers.TV Playlist

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞ (–≤ 0, 3, 6, 9, 12, 15, 18, 21 —á–∞—Å)
    - cron: '0 */3 * * *'
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub
  workflow_dispatch:
    inputs:
      reason:
        description: '–ü—Ä–∏—á–∏–Ω–∞ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞'
        required: false
        default: 'Manual update by user'

env:
  # –í–∞—à URL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ PythonAnywhere
  APP_URL: "https://Tipicon80.pythonanywhere.com"

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: üïí –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
      run: |
        echo "üïí –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: $(date)"
        echo "üåê –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: $(date +%Z)"
        echo "üìÖ –î–∞—Ç–∞: $(date +'%Y-%m-%d %H:%M:%S')"
        
    - name: üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      id: setup
      run: |
        # –°–æ–∑–¥–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π URL-encoded –∫–ª—é—á
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º Python –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
        python3 -c "
        import urllib.parse
        key = '${{ secrets.SECRET_KEY }}'
        # URL-encode –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        encoded = urllib.parse.quote(key, safe='')
        print('SECRET_KEY_ENCODED=' + encoded)
        " >> $GITHUB_ENV
        
        echo "üîë –ö–ª—é—á –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω (–ø–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤): ${SECRET_KEY_ENCODED:0:20}..."
        
    - name: üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞
      id: update
      run: |
        echo "üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞..."
        echo "üåê URL: $APP_URL/update_playlist"
        
        # –î–µ–ª–∞–µ–º HTTP-–∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏
        RESPONSE=$(curl -s \
          --connect-timeout 30 \
          --max-time 60 \
          -w "\nHTTP_STATUS:%{http_code}" \
          "${APP_URL}/update_playlist?key=${SECRET_KEY_ENCODED}")
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º HTTP —Å—Ç–∞—Ç—É—Å
        HTTP_STATUS=$(echo "$RESPONSE" | grep 'HTTP_STATUS:' | cut -d':' -f2)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (–±–µ–∑ —Å—Ç—Ä–æ–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º)
        RESPONSE_BODY=$(echo "$RESPONSE" | grep -v 'HTTP_STATUS:')
        
        echo "üìä HTTP —Å—Ç–∞—Ç—É—Å: $HTTP_STATUS"
        echo "üìù –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
        echo "$RESPONSE_BODY"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
        echo "http_status=$HTTP_STATUS" >> $GITHUB_OUTPUT
        echo "response_body<<EOF" >> $GITHUB_OUTPUT
        echo "$RESPONSE_BODY" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
        if [ "$HTTP_STATUS" -eq 200 ]; then
          echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          echo "LAST_UPDATE_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          exit 0
        else
          echo "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è! –°—Ç–∞—Ç—É—Å: $HTTP_STATUS"
          exit 1
        fi
        
    - name: ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—Ö–∞
      if: success()
      run: |
        echo "üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
        echo "üïí –í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: $LAST_UPDATE_TIME"
        echo "üìã –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:"
        echo "${{ steps.update.outputs.response_body }}"
        
        # –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—ã–π –æ—Ç—á–µ—Ç
        echo "## üìä –û—Ç—á–µ—Ç –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ‚úÖ –£—Å–ø–µ—à–Ω–æ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**–í—Ä–µ–º—è:** $LAST_UPDATE_TIME" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.update.outputs.response_body }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞" >> $GITHUB_STEP_SUMMARY
        
    - name: üìß –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ email (–ø—Ä–∏ –æ—à–∏–±–∫–µ)
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "‚ùå Peers.TV: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–∞"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: GitHub Actions <noreply@github.com>
        html: true
        body: |
          <h2>‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–∞ Peers.TV</h2>
          
          <p><strong>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</strong> ${{ github.repository }}</p>
          <p><strong>Workflow:</strong> ${{ github.workflow }}</p>
          <p><strong>–ó–∞–ø—É—Å–∫:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">#${{ github.run_number }}</a></p>
          <p><strong>–í—Ä–µ–º—è:</strong> $(date +'%Y-%m-%d %H:%M:%S')</p>
          <p><strong>–°—Ç–∞—Ç—É—Å HTTP:</strong> ${{ steps.update.outputs.http_status }}</p>
          
          <h3>–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</h3>
          <pre>${{ steps.update.outputs.response_body }}</pre>
          
          <hr>
          <p><small>–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç GitHub Actions</small></p>
        
    - name: üí¨ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Discord (–ø—Ä–∏ –æ—à–∏–±–∫–µ)
      if: failure()
      uses: sarisia/actions-status-discord@v1
      with:
        webhook: ${{ secrets.DISCORD_WEBHOOK }}
        status: ${{ job.status }}
        title: "‚ùå Peers.TV: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
        description: |
          –°—Ç–∞—Ç—É—Å: ${{ steps.update.outputs.http_status }}
          –ó–∞–ø—É—Å–∫: #${{ github.run_number }}
          –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        color: 0xFF0000
        username: "GitHub Actions"
        avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
        
    - name: üèÅ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ workflow
      run: |
        echo "üèÅ Workflow –∑–∞–≤–µ—Ä—à–µ–Ω"
        echo "üïí –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: $(date)"
        echo "‚è∞ –°–ª–µ–¥—É—é—â–µ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —á–µ—Ä–µ–∑ 3 —á–∞—Å–∞"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ –í—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
        else
          echo "‚ùå Workflow –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏"
        fi
